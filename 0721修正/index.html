<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/leaflet.css">
    <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
    <link rel="stylesheet" href="css/qgis2web.css">
    <link rel="stylesheet" href="css/fontawesome-all.min.css">
    <link rel="stylesheet" href="css/MarkerCluster.css">
    <link rel="stylesheet" href="css/MarkerCluster.Default.css">

    <!-- スマホ対応マップサイズ -->
    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
      }
      #map {
        width: 100vw;
        height: 100vh;
      }
    </style>
    <title>Otogawa Webmap</title>
  </head>

  <body>
    <div id="map"></div>

    <!-- JS -->
    <script src="js/qgis2web_expressions.js"></script>
    <script src="js/leaflet.js"></script>
    <script src="js/L.Control.Layers.Tree.min.js"></script>
    <script src="js/leaflet.rotatedMarker.js"></script>
    <script src="js/leaflet.pattern.js"></script>
    <script src="js/leaflet-hash.js"></script>
    <script src="js/Autolinker.min.js"></script>
    <script src="js/rbush.min.js"></script>
    <script src="js/labelgun.min.js"></script>
    <script src="js/labels.js"></script>
    <script src="js/leaflet.markercluster.js"></script>

    <!-- レイヤーデータ -->
    <script src="data/_1.js"></script>
    <script src="data/gis_2.js"></script>

    <!-- Leaflet地図本体 -->
    <script>
      var map = L.map('map', {
        zoomControl: false,
        maxZoom: 28,
        minZoom: 1
      }).fitBounds([[35.02150630669538,136.89041981871463],[35.024273635120316,136.89502311629542]]);
      
      var hash = new L.Hash(map);
      var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});
      var zoomControl = L.control.zoom({position: 'topleft'}).addTo(map);
      var bounds_group = new L.featureGroup([]);
      function setBounds() {}

      // 背景：国土地理院シームレス写真
      map.createPane('pane_03___0');
      map.getPane('pane_03___0').style.zIndex = 400;
      var layer_03___0 = L.tileLayer(
        'https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg',
        {
          pane: 'pane_03___0',
          opacity: 1.0,
          minZoom: 1,
          maxZoom: 28,
          minNativeZoom: 2,
          maxNativeZoom: 18,
          attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html" target="_blank">出典：国土地理院</a>'
        }
      );
      map.addLayer(layer_03___0);

      // ポップアップ共通処理
      function removeEmptyRowsFromPopupContent(content, feature) {
        var tempDiv = document.createElement('div');
        tempDiv.innerHTML = content;
        var rows = tempDiv.querySelectorAll('tr');
        for (var i = 0; i < rows.length; i++) {
          var td = rows[i].querySelector('td.visible-with-data');
          var key = td ? td.id : '';
          if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
            rows[i].parentNode.removeChild(rows[i]);
          }
        }
        return tempDiv.innerHTML;
      }
      function addClassToPopupIfMedia(content, popup) {
        var tempDiv = document.createElement('div');
        tempDiv.innerHTML = content;
        if (tempDiv.querySelector('td img')) {
          popup._contentNode.classList.add('media');
          setTimeout(function() { popup.update(); }, 10);
        } else {
          popup._contentNode.classList.remove('media');
        }
      }

      // 枠レイヤー
      function pop__1(feature, layer) {
        var popupContent = '<table><tr><td colspan="2">' +
          (feature.properties['fid'] !== null ? autolinker.link(String(feature.properties['fid'])) : '') +
          '</td></tr></table>';
        var content = removeEmptyRowsFromPopupContent(popupContent, feature);
        layer.on('popupopen', function(e) { addClassToPopupIfMedia(content, e.popup); });
        layer.bindPopup(content, { maxHeight: 400 });
      }
      function style__1_0() {
        return {
          pane: 'pane__1',
          opacity: 1,
          color: 'rgba(227,26,28,1.0)',
          weight: 11.0,
          fill: true,
          fillOpacity: 0,
          fillColor: 'rgba(231,113,72,0.0)',
          interactive: true
        };
      }
      map.createPane('pane__1');
      map.getPane('pane__1').style.zIndex = 401;
      var layer__1 = new L.geoJson(json__1, {
        pane: 'pane__1',
        onEachFeature: pop__1,
        style: style__1_0,
        interactive: true
      });
      bounds_group.addLayer(layer__1);
      map.addLayer(layer__1);

      // 点レイヤー
      function pop_gis_2(feature, layer) {
        var popupContent = '<table>' +
          '<tr><td colspan="2">' +
            (feature.properties['fid'] !== null ? autolinker.link(String(feature.properties['fid'])) : '') +
          '</td></tr>' +
          '<tr><td colspan="2">' +
            (feature.properties['URL'] !== null ? autolinker.link(String(feature.properties['URL'])) : '') +
          '</td></tr>' +
        '</table>';
        var content = removeEmptyRowsFromPopupContent(popupContent, feature);
        layer.on('popupopen', function(e) { addClassToPopupIfMedia(content, e.popup); });
        layer.bindPopup(content, { maxHeight: 400 });
      }
      function style_gis_2_0() {
        return {
          pane: 'pane_gis_2',
          radius: 4.0,
          color: 'rgba(35,35,35,1.0)',
          weight: 1,
          fill: true,
          fillOpacity: 1,
          fillColor: 'rgba(229,182,54,1.0)',
          interactive: true
        };
      }
      map.createPane('pane_gis_2');
      map.getPane('pane_gis_2').style.zIndex = 402;
      var layer_gis_2 = new L.geoJson(json_gis_2, {
        pane: 'pane_gis_2',
        onEachFeature: pop_gis_2,
        pointToLayer: function(feature, latlng) {
          return L.circleMarker(latlng, style_gis_2_0());
        },
        interactive: true
      });
      var cluster_gis_2 = L.markerClusterGroup({
        showCoverageOnHover: false,
        spiderfyDistanceMultiplier: 2
      });
      cluster_gis_2.addLayer(layer_gis_2);
      bounds_group.addLayer(layer_gis_2);
      map.addLayer(cluster_gis_2);

      // レイヤーコントロール
      L.control.layers.tree(
        null,
        [
          { label: '<img src="legend/gis_2.png" /> gis点', layer: cluster_gis_2 },
          { label: '<img src="legend/_1.png" /> 枠', layer: layer__1 },
          { label: '03_地理院タイル', layer: layer_03___0, radioGroup: 'bm' }
        ],
        { collapsed: true }
      ).addTo(map);

      setBounds();
    </script>
  </body>
</html>