<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- ★ スマホ最適化：全画面・ピンチOK・アドレスバー考慮 -->
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, width=device-width, viewport-fit=cover, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <!-- お手本と同じアセット -->
  <link rel="stylesheet" href="css/leaflet.css">
  <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
  <link rel="stylesheet" href="css/qgis2web.css">
  <link rel="stylesheet" href="css/fontawesome-all.min.css">
  <link rel="stylesheet" href="css/MarkerCluster.css">
  <link rel="stylesheet" href="css/MarkerCluster.Default.css">

  <style>
    /* ★ 画面いっぱいに地図（固定pxから全面へ） */
    html, body { height: 100%; margin: 0; }
    #map { width: 100vw; height: 100svh; touch-action: pan-x pan-y pinch-zoom; }

    /* レイヤ欄（ツリー）— スマホでも操作しやすくスクロール可 */
    .leaflet-control-layers, .leaflet-control-layers-tree { max-height: 70svh; overflow: auto; }

    /* 余白（ズームボタンと干渉する場合は調整） */
    @media (max-width: 900px){
      .leaflet-top.leaflet-right .leaflet-control-layers { margin-top: 8px; }
    }
  </style>
  <title>Mobile Web Map</title>
</head>
<body>
  <div id="map"></div>

  <!-- お手本のJSと同じ順序 -->
  <script src="js/qgis2web_expressions.js"></script>
  <script src="js/leaflet.js"></script>
  <script src="js/L.Control.Layers.Tree.min.js"></script>
  <script src="js/leaflet.rotatedMarker.js"></script>
  <script src="js/leaflet.pattern.js"></script>
  <script src="js/leaflet-hash.js"></script>
  <script src="js/Autolinker.min.js"></script>
  <script src="js/rbush.min.js"></script>
  <script src="js/labelgun.min.js"></script>
  <script src="js/labels.js"></script>
  <script src="js/leaflet.markercluster.js"></script>

  <!-- データ -->
  <script src="data/_2.js"></script>
  <script src="data/gis_3.js"></script>

  <script>
    // ★ ぼけ防止：地理院タイルのネイティブ上限に合わせる（Retinaも使用）
    const MAX_NATIVE_ZOOM = 18;

    // お手本ベース：fitBounds + ハッシュ
    const map = L.map('map', {
      zoomControl: false,
      minZoom: 1,
      maxZoom: MAX_NATIVE_ZOOM,   // ← 28 から 18 に。過ズーム補間でボケない
      zoomSnap: 1,                // ← 小数ズームを避けてボケ防止
      zoomDelta: 1
    }).fitBounds([[35.02169835485059,136.88604755471448],[35.02575102115678,136.89555729652628]]);

    new L.Hash(map);

    // 出典（お手本通り＋地理院表記）
    map.attributionControl.setPrefix(
      '<a href="https://github.com/tomchadwin/qgis2web" target="_blank" rel="noopener">qgis2web</a> &middot; ' +
      '<a href="https://leafletjs.com" target="_blank" rel="noopener">Leaflet</a> &middot; ' +
      '<a href="https://qgis.org" target="_blank" rel="noopener">QGIS</a>'
    );
    map.attributionControl.addAttribution('地理院タイル（国土地理院）');

    const autolinker = new Autolinker({ truncate: { length: 30, location: 'smart' } });

    // ズームUIは画面の右上（レイヤ欄の近く）
    L.control.zoom({ position: 'topright' }).addTo(map);

    const bounds_group = new L.featureGroup([]);
    function setBounds(){}

    // ===== ベースマップ（お手本に準拠・Retina対応） =====
    map.createPane('pane_03___0'); map.getPane('pane_03___0').style.zIndex = 400;
    const layer_03___0 = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg', {
      pane: 'pane_03___0',
      opacity: 1.0,
      minZoom: 1,
      maxZoom: MAX_NATIVE_ZOOM,
      maxNativeZoom: MAX_NATIVE_ZOOM,
      detectRetina: true
    });

    map.createPane('pane___1'); map.getPane('pane___1').style.zIndex = 401;
    const layer___1 = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', {
      pane: 'pane___1',
      opacity: 1.0,
      minZoom: 1,
      maxZoom: MAX_NATIVE_ZOOM,
      maxNativeZoom: MAX_NATIVE_ZOOM,
      detectRetina: true
    }).addTo(map); // 初期は淡色

    // ===== 枠（お手本のスタイルのまま） =====
    function pop__2(feature, layer){
      const popupContent =
        '<table><tr><td colspan="2">' +
        (feature.properties['fid'] != null ? autolinker.link(String(feature.properties['fid'])) : '') +
        '</td></tr></table>';
      layer.bindPopup(popupContent, { maxHeight: 400 });
    }
    function style__2_0(){
      return {
        pane: 'pane__2',
        opacity: 1,
        color: 'rgba(227,26,28,1.0)',
        lineCap: 'butt',
        lineJoin: 'miter',
        weight: 11,                  // お手本通り
        fill: true,
        fillOpacity: 1,
        fillColor: 'rgba(231,113,72,0.0)',
        interactive: true
      }
    }
    map.createPane('pane__2'); map.getPane('pane__2').style.zIndex = 402;
    map.getPane('pane__2').style['mix-blend-mode'] = 'normal';
    const layer__2 = new L.geoJson(json__2, {
      attribution: '',
      interactive: true,
      dataVar: 'json__2',
      layerName: 'layer__2',
      pane: 'pane__2',
      onEachFeature: pop__2,
      style: style__2_0
    }).addTo(map);
    bounds_group.addLayer(layer__2);

    // ===== 点（お手本の見た目を保ちつつ“スマホでも過剰に巨大化しない”半径） =====
    //   お手本 = 半径10。スマホ視認性を考慮して半径8に調整（※ご希望があれば数値で指示ください）
    function pop_gis_3(feature, layer){
      const popupContent =
        '<table>' +
          '<tr><td colspan="2">' + (feature.properties['fid'] != null ? autolinker.link(String(feature.properties['fid'])) : '') + '</td></tr>' +
          '<tr><td colspan="2">' + (feature.properties['URL'] != null ? autolinker.link(String(feature.properties['URL'])) : '') + '</td></tr>' +
        '</table>';
      layer.bindPopup(popupContent, { maxHeight: 400 });
    }
    function style_gis_3_0(){
      return {
        pane: 'pane_gis_3',
        radius: 8.0,                 // ← スマホ向けに少し小さく（お手本は10）
        opacity: 1,
        color: 'rgba(35,35,35,1.0)',
        weight: 2,                   // お手本は1。モバイルでも視認しやすく2に（要望あれば戻します）
        fill: true,
        fillOpacity: 1,
        fillColor: 'rgba(229,182,54,1.0)',
        interactive: true
      }
    }
    map.createPane('pane_gis_3'); map.getPane('pane_gis_3').style.zIndex = 403;
    map.getPane('pane_gis_3').style['mix-blend-mode'] = 'normal';
    const layer_gis_3 = new L.geoJson(json_gis_3, {
      attribution: '',
      interactive: true,
      dataVar: 'json_gis_3',
      layerName: 'layer_gis_3',
      pane: 'pane_gis_3',
      onEachFeature: pop_gis_3,
      pointToLayer: (feature, latlng)=> L.circleMarker(latlng, style_gis_3_0(feature))
    });

    // お手本どおりにクラスタを使用（表示密度対策）
    const cluster_gis_3 = new L.MarkerClusterGroup({ showCoverageOnHover:false, spiderfyDistanceMultiplier:2 });
    cluster_gis_3.addLayer(layer_gis_3);
    cluster_gis_3.addTo(map);
    bounds_group.addLayer(layer_gis_3);

    // ===== レイヤツリー（お手本準拠・スマホでも使いやすい） =====
    const overlaysTree = [
      { label:'<img src="legend/gis_3.png" /> gis点', layer: cluster_gis_3 },
      { label:'<img src="legend/_2.png" /> 枠', layer: layer__2 },
      { label:'地理院タイル_淡色地図', layer: layer___1, radioGroup:'bm' },
      { label:'03_地理院タイル_(全国最新写真（シームレス））', layer: layer_03___0, radioGroup:'bm' }
    ];
    // 位置：右上（地図UIとして追従）。必要なら 'topleft' に変更可能
    L.control.layers.tree(null, overlaysTree, { collapsed:true, position:'topright' }).addTo(map);

    // ===== 仕上げ：回転・アドレスバー変動での再計測（スマホのぼけ・ズレ防止） =====
    map.whenReady(()=> map.invalidateSize());
    addEventListener('orientationchange', ()=> setTimeout(()=> map.invalidateSize(), 200), { passive:true });
    addEventListener('resize',            ()=> setTimeout(()=> map.invalidateSize(), 200), { passive:true });
  </script>
</body>
</html>