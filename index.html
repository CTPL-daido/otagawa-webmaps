<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>地理院タイル切替（常時パネル表示・Tree版）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- Leaflet（CDN） -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- L.Control.Layers.Tree（CDN） -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.control.layers.tree@2.0.2/L.Control.Layers.Tree.css" />
  <script src="https://unpkg.com/leaflet.control.layers.tree@2.0.2/L.Control.Layers.Tree.min.js"></script>

  <!-- MarkerCluster（CDN） -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- Hash（CDN） -->
  <script src="https://unpkg.com/leaflet-hash@0.2.1/leaflet-hash.js"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    body { overscroll-behavior: none; touch-action: pan-x pan-y; }
    #map { padding-bottom: env(safe-area-inset-bottom); }

    /* 右上のパネルをスマホでも見やすく */
    .leaflet-top.leaflet-right { top: 10px; right: 10px; z-index: 1000; }
    .leaflet-control-layers {
      background: rgba(255,255,255,.96);
      font-size: 16px;            /* タップしやすい */
      border-radius: 10px;
      box-shadow: 0 4px 16px rgba(0,0,0,.15);
      max-height: 65vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding-right: 6px;         /* スクロールバーの余白 */
    }
    /* 標準のトグルボタンは使わず、常時開いた箱にする */
    .leaflet-control-layers-toggle { display: none; }

    /* 出典の視認性 */
    .leaflet-control-attribution {
      background: rgba(255,255,255,.9);
      padding: 2px 6px;
      border-radius: 4px 0 0 0;
    }

    /* 行内アイコン（インラインSVG） */
    .legend-icon { display:inline-block; width:14px; height:14px; vertical-align:middle; margin-right:6px; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- ▼ あなたの qgis2web 出力を読み込む（ファイル名は何でもOK） -->
  <script src="data/_1.js"></script>
  <script src="data/gis_2.js"></script>
  <!-- ▲ 追加があればさらに <script src="data/xxx.js"></script> を足してください -->

  <script>
    // ===== マップ初期化 =====
    const map = L.map('map', { zoomControl:false, maxZoom:18, minZoom:1, tap:true })
                 .fitBounds([[35.018,136.883],[35.028,136.900]]);
    new L.Hash(map);

    // 左上ズーム
    L.control.zoom({ position: 'topleft' }).addTo(map);

    // 左下クレジット（固定）
    map.attributionControl.setPrefix(
      '<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> · ' +
      '<a href="https://leafletjs.com" target="_blank">Leaflet</a> · ' +
      '<a href="https://qgis.org" target="_blank">QGIS</a>'
    );

    // ===== ベース（地理院タイル） =====
    const gsiListUrl = 'https://maps.gsi.go.jp/development/ichiran.html';
    const basePale  = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', {
      minZoom:1, maxZoom:18,
      attribution: '出典：<a href="'+gsiListUrl+'" target="_blank" rel="noopener">地理院タイル</a>（淡色地図）'
    }).addTo(map); // 初期は淡色
    const basePhoto = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg', {
      minZoom:1, maxZoom:18,
      attribution: '出典：<a href="'+gsiListUrl+'" target="_blank" rel="noopener">地理院タイル</a>（全国最新写真）'
    });

    // ===== data/*.js の変数名を自動検出 =====
    function collectGeoJSON(){
      const polys=[], points=[];
      for(const k in window){
        if(!/^json[_A-Za-z0-9]*$/.test(k)) continue;
        const v=window[k];
        if(!v || v.type!=='FeatureCollection' || !Array.isArray(v.features) || !v.features.length) continue;
        const t=v.features[0]?.geometry?.type;
        if(t==='Polygon'||t==='MultiPolygon') polys.push(v);
        if(t==='Point'  ||t==='MultiPoint')   points.push(v);
      }
      return {polys, points};
    }
    const found = collectGeoJSON();

    // ===== オーバーレイ作成 =====
    const overlays = {};
    let layerPolygon=null, layerPointsRaw=null, clusterPoints=null;

    if(found.polys.length){
      const polyFC = found.polys.length>1 ? {type:'FeatureCollection',features:found.polys.flatMap(v=>v.features)} : found.polys[0];
      layerPolygon = L.geoJSON(polyFC, {
        interactive:true,
        style:()=>({color:'red', weight:6, opacity:1, fill:false})
      }).addTo(map);
      overlays['枠（ポリゴン）'] = layerPolygon;
    }

    if(found.points.length){
      const pointFC = found.points.length>1 ? {type:'FeatureCollection',features:found.points.flatMap(v=>v.features)} : found.points[0];
      layerPointsRaw = L.geoJSON(pointFC, {
        interactive:true,
        pointToLayer:(f,latlng)=>L.circleMarker(latlng,{radius:7, fillColor:'#ffcc00', color:'#000', weight:1.5, opacity:1, fillOpacity:1})
      });
      clusterPoints = L.markerClusterGroup({ showCoverageOnHover:false, spiderfyOnMaxZoom:true, disableClusteringAtZoom:17 })
                       .addLayer(layerPointsRaw).addTo(map);
      overlays['gis点'] = clusterPoints;
    }

    // ===== アイコン（インラインSVG） =====
    const iconPoint = '<span class="legend-icon" style="background:url(\'data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2214%22 height=%2214%22><circle cx=%227%22 cy=%227%22 r=%226%22 fill=%22%23ffcc00%22 stroke=%22%23000%22 stroke-width=%221.2%22/></svg>\') no-repeat center/14px 14px"></span>';
    const iconPoly  = '<span class="legend-icon" style="background:url(\'data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2214%22 height=%2214%22><rect x=%222%22 y=%222%22 width=%2210%22 height=%2210%22 fill=%22%23e00%22 stroke=%22%23b00%22 stroke-width=%221%22/></svg>\') no-repeat center/14px 14px"></span>';

    // ===== Treeパネル（ベース＝ラジオ、オーバーレイ＝チェック） =====
    const baseTree = {
      label: '',
      children: [
        { label: '地理院タイル（淡色地図）', layer: basePale,  radioGroup: 'basemap' },
        { label: '地理院タイル（全国最新写真）', layer: basePhoto, radioGroup: 'basemap' }
      ]
    };

    const overlayTree = {
      label: '',
      children: [
        { label: iconPoint + 'gis点', layer: overlays['gis点'] },
        { label: iconPoly  + '枠',    layer: overlays['枠（ポリゴン）'] }
      ].filter(x => x.layer) // ないものは除外
    };

    // 常時開いた白いパネルとして表示（collapsed:false）
    L.control.layers.tree(baseTree, overlayTree, {
      collapsed: false,
      namedToggle: false,        // 見出しのトグルを出さない
      selectAllCheckbox: false,  // “全選択”は今回はオフ
      position: 'topright'
    }).addTo(map);

    // ===== 表示範囲をデータに合わせる =====
    const fitTargets=[];
    if(layerPolygon)   fitTargets.push(layerPolygon);
    if(layerPointsRaw) fitTargets.push(layerPointsRaw);
    if(fitTargets.length){
      const fg=L.featureGroup(fitTargets);
      map.fitBounds(fg.getBounds(), {padding:[10,10]});
    }
  </script>
</body>
</html>