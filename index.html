<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="css/leaflet.css">
    <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
    <link rel="stylesheet" href="css/qgis2web.css">
    <link rel="stylesheet" href="css/fontawesome-all.min.css">
    <link rel="stylesheet" href="css/MarkerCluster.css">
    <link rel="stylesheet" href="css/MarkerCluster.Default.css">
    <style>
      #map { width: 1149px; height: 844px; }
    </style>
    <title>地理院タイル切替マップ</title>
  </head>
  <body>
    <div id="map"></div>

    <script src="js/qgis2web_expressions.js"></script>
    <script src="js/leaflet.js"></script>
    <script src="js/L.Control.Layers.Tree.min.js"></script>
    <script src="js/leaflet.rotatedMarker.js"></script>
    <script src="js/leaflet.pattern.js"></script>
    <script src="js/leaflet-hash.js"></script>
    <script src="js/Autolinker.min.js"></script>
    <script src="js/rbush.min.js"></script>
    <script src="js/labelgun.min.js"></script>
    <script src="js/labels.js"></script>
    <script src="js/leaflet.markercluster.js"></script>

    <!-- データ -->
    <script src="data/_2.js"></script>
    <script src="data/gis_3.js"></script>

    <script>
      const map = L.map('map', { zoomControl:false, maxZoom:18, minZoom:1 })
        .fitBounds([[35.00873592469054,136.8754285322846],[35.03087538697442,136.9122549129309]]);
      new L.Hash(map);

      // 左下の固定表示
      map.attributionControl.setPrefix(
        '<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; ' +
        '<a href="https://leafletjs.com" title="A JS library for interactive maps" target="_blank">Leaflet</a> &middot; ' +
        '<a href="https://qgis.org" target="_blank">QGIS</a>'
      );
      const autolinker = new Autolinker({ truncate: { length: 30, location: 'smart' } });

      L.control.zoom({ position: 'topleft' }).addTo(map);
      const bounds_group = new L.featureGroup([]);

      // --- ベースレイヤ（出典を追記） ---
      const gsiListUrl = 'https://maps.gsi.go.jp/development/ichiran.html';

      map.createPane('pane_03___0');
      map.getPane('pane_03___0').style.zIndex = 400;
      const layer_03___0 = L.tileLayer(
        'https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg',
        {
          pane: 'pane_03___0',
          opacity: 1.0,
          attribution: '出典：<a href="'+gsiListUrl+'" target="_blank" rel="noopener">地理院タイル</a>（全国最新写真）',
          minZoom: 1, maxZoom: 18, minNativeZoom: 2, maxNativeZoom: 18
        }
      );
      map.addLayer(layer_03___0);

      map.createPane('pane___1');
      map.getPane('pane___1').style.zIndex = 401;
      const layer___1 = L.tileLayer(
        'https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png',
        {
          pane: 'pane___1',
          opacity: 1.0,
          attribution: '出典：<a href="'+gsiListUrl+'" target="_blank" rel="noopener">地理院タイル</a>（淡色地図）',
          minZoom: 1, maxZoom: 18, minNativeZoom: 2, maxNativeZoom: 18
        }
      );
      map.addLayer(layer___1);

      // --- 枠 ---
      function pop__2(feature, layer) {
        const popupContent = '<table><tr><td colspan="2">' +
          (feature.properties['fid'] !== null ? autolinker.link(String(feature.properties['fid']).replace(/'/g, '\'').toLocaleString()) : '') +
          '</td></tr></table>';
        layer.on('popupopen', e => { /* 既定の処理 */ });
        layer.bindPopup(popupContent, { maxHeight: 400 });
      }
      function style__2_0() {
        return { pane: 'pane__2', opacity: 1, color: 'rgba(227,26,28,1.0)', dashArray: '',
                 lineCap: 'butt', lineJoin: 'miter', weight: 11.0, fill: true, fillOpacity: 1,
                 fillColor: 'rgba(231,113,72,0.0)', interactive: true };
      }
      map.createPane('pane__2');
      map.getPane('pane__2').style.zIndex = 402;
      map.getPane('pane__2').style['mix-blend-mode'] = 'normal';
      const layer__2 = new L.geoJson(json__2, {
        attribution: '',
        interactive: true,
        dataVar: 'json__2',
        layerName: 'layer__2',
        pane: 'pane__2',
        onEachFeature: pop__2,
        style: style__2_0
      });
      bounds_group.addLayer(layer__2);
      map.addLayer(layer__2);

      // --- 点（クラスタ） ---
      function pop_gis_3(feature, layer) {
        const popupContent = '<table>' +
          '<tr><td colspan="2">' + (feature.properties['fid'] !== null ? autolinker.link(String(feature.properties['fid']).replace(/\'/g, '\'').toLocaleString()) : '') + '</td></tr>' +
          '<tr><td colspan="2">' + (feature.properties['url'] !== null ? autolinker.link(String(feature.properties['url']).replace(/\'/g, '\'').toLocaleString()) : '') + '</td></tr>' +
          '</table>';
        layer.bindPopup(popupContent, { maxHeight: 400 });
      }
      function style_gis_3_0() {
        return { pane: 'pane_gis_3', radius: 8.0, opacity: 1, color: 'rgba(0,0,0,1.0)',
                 dashArray: '', lineCap: 'butt', lineJoin: 'miter', weight: 2.0,
                 fill: true, fillOpacity: 1, fillColor: 'rgba(255,255,255,1.0)', interactive: true };
      }
      map.createPane('pane_gis_3');
      map.getPane('pane_gis_3').style.zIndex = 403;
      map.getPane('pane_gis_3').style['mix-blend-mode'] = 'normal';
      const layer_gis_3 = new L.geoJson(json_gis_3, {
        attribution: '',
        interactive: true,
        dataVar: 'json_gis_3',
        layerName: 'layer_gis_3',
        pane: 'pane_gis_3',
        onEachFeature: pop_gis_3,
        pointToLayer: (feature, latlng) => L.circleMarker(latlng, style_gis_3_0(feature))
      });
      const cluster_gis_3 = new L.MarkerClusterGroup({ showCoverageOnHover: false, spiderfyDistanceMultiplier: 2 });
      cluster_gis_3.addLayer(layer_gis_3);
      bounds_group.addLayer(layer_gis_3);
      cluster_gis_3.addTo(map);

      // --- レイヤ一覧（既存のまま） ---
      const overlaysTree = [
        { label: '<img src="legend/gis_3.png" /> gis点', layer: cluster_gis_3 },
        { label: '<img src="legend/_2.png" /> 枠', layer: layer__2 },
        { label: '地理院タイル_淡色地図', layer: layer___1, radioGroup: 'bm' },
        { label: '03_地理院タイル_(全国最新写真（シームレス））', layer: layer_03___0, radioGroup: 'bm' }
      ];
      L.control.layers.tree(null, overlaysTree, { collapsed: true }).addTo(map);
    </script>
  </body>
</html>