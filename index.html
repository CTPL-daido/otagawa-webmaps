<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>スマホ用ピンチ最適化マップ</title>

  <!-- スマホ最適化：ブラウザ拡大は無効化し、ピンチはLeafletへ -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />

  <!-- 既存アセット（お手本に合わせてローカルのものを使う想定） -->
  <link rel="stylesheet" href="css/leaflet.css">
  <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
  <link rel="stylesheet" href="css/qgis2web.css">
  <link rel="stylesheet" href="css/fontawesome-all.min.css">
  <link rel="stylesheet" href="css/MarkerCluster.css">
  <link rel="stylesheet" href="css/MarkerCluster.Default.css">

  <style>
    html, body { height: 100%; margin: 0; }
    /* ★ ピンチを Leaflet に渡すために 'touch-action: none' が超重要 */
    #map {
      width: 100vw;
      height: 100svh;
      touch-action: none; /* ← これがないとブラウザがピンチを奪いがち */
    }

    /* レイヤ欄は“地図の右上”に追従（デフォ挙動）。固定CSSは一切当てない */
    .leaflet-control-layers,
    .leaflet-control-layers-tree { max-height: 70svh; overflow:auto; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- 既存JS（お手本通りの並び） -->
  <script src="js/qgis2web_expressions.js"></script>
  <script src="js/leaflet.js"></script>
  <script src="js/L.Control.Layers.Tree.min.js"></script>
  <script src="js/leaflet.rotatedMarker.js"></script>
  <script src="js/leaflet.pattern.js"></script>
  <script src="js/leaflet-hash.js"></script>
  <script src="js/Autolinker.min.js"></script>
  <script src="js/rbush.min.js"></script>
  <script src="js/labelgun.min.js"></script>
  <script src="js/labels.js"></script>
  <script src="js/leaflet.markercluster.js"></script>

  <!-- データ（お手本の構成に合わせて） -->
  <script src="data/_2.js"></script>
  <script src="data/gis_3.js"></script>

  <script>
    // ====== マップ：ピンチ前提の設定 ======
    const MAX_Z = 18; // 地理院タイルの実質上限

    const map = L.map('map', {
      // ピンチでの挙動を Leaflet に任せる
      touchZoom: 'center',   // ★ ピンチは中心基準で滑らか
      tap: false,            // 一部端末でのゴーストタップ対策
      zoomControl: false,    // 画面+ボタンは使えるけど今回は左上に後付け
      minZoom: 1,
      maxZoom: MAX_Z,
      zoomSnap: 0.5,         // ★ 0.5刻み：ピンチが滑らか、かつ過度なぼけを抑制
      zoomDelta: 0.5,
      zoomAnimation: true
    }).fitBounds([[35.02169835485059,136.88604755471448],[35.02575102115678,136.89555729652628)]);

    new L.Hash(map);
    L.control.zoom({ position: 'topleft' }).addTo(map);

    // ====== 出典（明示） ======
    map.attributionControl.setPrefix(
      '<a href="https://github.com/tomchadwin/qgis2web" target="_blank" rel="noopener">qgis2web</a> · ' +
      '<a href="https://leafletjs.com" target="_blank" rel="noopener">Leaflet</a> · ' +
      '<a href="https://qgis.org" target="_blank" rel="noopener">QGIS</a>'
    );
    map.attributionControl.addAttribution(
      '出典：<a href="https://maps.gsi.go.jp/development/ichiran.html" target="_blank" rel="noopener">地理院タイル（国土地理院）</a>'
    );

    const autolinker = new Autolinker({ truncate: { length: 30, location: 'smart' } });

    // ====== ベースタイル（GSI：淡色／シームレス写真） ======
    map.createPane('pane_photo'); map.getPane('pane_photo').style.zIndex = 400;
    const layerPhoto = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg', {
      pane: 'pane_photo',
      maxZoom: MAX_Z,
      maxNativeZoom: MAX_Z   // ★ ネイティブ上限と合わせる（過ズーム白画面回避）
    });

    map.createPane('pane_pale'); map.getPane('pane_pale').style.zIndex = 401;
    const layerPale = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', {
      pane: 'pane_pale',
      maxZoom: MAX_Z,
      maxNativeZoom: MAX_Z
    }).addTo(map); // 初期：淡色

    // ====== 枠 ======
    function pop__2(feature, layer) {
      const html =
        '<table><tr><td colspan="2">' +
          (feature.properties['fid'] != null ? autolinker.link(String(feature.properties['fid'])) : '') +
        '</td></tr></table>';
      layer.bindPopup(html, { maxHeight: 400 });
    }
    function style__2_0(){
      return { pane:'pane__2', opacity:1, color:'rgba(227,26,28,1.0)', weight:11,
               fill:true, fillOpacity:1, fillColor:'rgba(231,113,72,0.0)', interactive:true };
    }
    map.createPane('pane__2'); map.getPane('pane__2').style.zIndex = 402;
    const layer__2 = L.geoJSON(json__2, { pane:'pane__2', style: style__2_0, onEachFeature: pop__2 }).addTo(map);

    // ====== 点（半径固定。ズームやタップでもサイズ不変） ======
    function pop_gis_3(feature, layer) {
      const html =
        '<table>' +
          '<tr><td colspan="2">' + (feature.properties['fid'] != null ? autolinker.link(String(feature.properties['fid'])) : '') + '</td></tr>' +
          '<tr><td colspan="2">' + (feature.properties['URL'] != null ? autolinker.link(String(feature.properties['URL'])) : '') + '</td></tr>' +
        '</table>';
      layer.bindPopup(html, { maxHeight: 400 });
    }
    function style_gis_3_0(){
      return { pane:'pane_gis_3', radius: 8, opacity:1, color:'rgba(35,35,35,1.0)',
               weight:2, fill:true, fillOpacity:1, fillColor:'rgba(229,182,54,1.0)', interactive:true };
    }
    map.createPane('pane_gis_3'); map.getPane('pane_gis_3').style.zIndex = 403;
    const layer_gis_3 = L.geoJSON(json_gis_3, {
      pane:'pane_gis_3',
      pointToLayer: (f, latlng)=> L.circleMarker(latlng, style_gis_3_0()),
      onEachFeature: pop_gis_3
    });

    // お手本どおりクラスタ適用（必要なければ layer_gis_3 を直接 addTo(map) に）
    const cluster = L.markerClusterGroup({ showCoverageOnHover:false, spiderfyDistanceMultiplier:2 });
    cluster.addLayer(layer_gis_3).addTo(map);

    // ====== レイヤ切替（地図の右上に追従） ======
    const overlaysTree = [
      { label:'<img src="legend/gis_3.png" /> gis点', layer: cluster },
      { label:'<img src="legend/_2.png" /> 枠', layer: layer__2 },
      { label:'地理院タイル_淡色地図', layer: layerPale,  radioGroup:'bm' },
      { label:'地理院タイル_全国最新写真', layer: layerPhoto, radioGroup:'bm' }
    ];
    L.control.layers.tree(null, overlaysTree, {
      collapsed: true,
      position: 'topright' // ★ “地図の右上”に追従（ピンチでもついてくる）
    }).addTo(map);

    // ====== 仕上げ：サイズ再計測（回転・UI変動でも崩れにくく） ======
    map.whenReady(()=> map.invalidateSize());
    addEventListener('orientationchange', ()=> setTimeout(()=> map.invalidateSize(), 200), { passive:true });
    addEventListener('resize',            ()=> setTimeout(()=> map.invalidateSize(), 200), { passive:true });
  </script>
</body>
</html>