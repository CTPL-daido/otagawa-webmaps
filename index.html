<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, width=device-width, viewport-fit=cover, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <!-- 既存のqgis2web資産を利用 -->
  <link rel="stylesheet" href="css/leaflet.css">
  <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
  <link rel="stylesheet" href="css/qgis2web.css">

  <style>
    html, body { margin:0; padding:0; height:100%; -webkit-tap-highlight-color: transparent; }
    #map { width:100vw; height:100svh; touch-action: pan-x pan-y pinch-zoom; }

    /* —— レイヤツリー：常に画面左上に“固定” —— */
    .leaflet-top.leaflet-left{
      position: fixed;    /* viewport基準で固定 */
      top: 8px;
      left: 8px;
      z-index: 10050;     /* UIが地図より常に上に来る */
      width: auto;
    }
    .leaflet-control-layers,
    .leaflet-control-layers-tree { max-height: 70svh; overflow:auto; }
    /* ズームボタンなどが左上にある場合の余白調整（必要に応じて） */
    .leaflet-top.leaflet-left .leaflet-control-layers { margin-top: 46px; }

    /* 枠は見えるがタップは通す（点のクリックを邪魔しない） */
    .leaflet-pane.pane-frame, .leaflet-pane.pane-frame * { pointer-events: none !important; }

    /* ===== トースト（何をタップしたか一時表示） ===== */
    .toast {
      position: fixed; left: 50%; bottom: 12px; transform: translateX(-50%);
      z-index: 10000; background: rgba(0,0,0,0.78); color:#fff;
      padding: 8px 12px; border-radius: 12px; font-size: 14px; line-height: 1.4;
      opacity: 0; transition: opacity .12s ease; pointer-events:none;
    }
    .toast.show { opacity: 1; }
  </style>

  <title>Webマップ（左上固定＋高精細ズーム・全部入り）</title>
</head>
<body>
  <div id="map"></div>

  <!-- 何をタップしたかトースト -->
  <div id="tapToast" class="toast" aria-live="polite" aria-atomic="true"></div>

  <!-- 既存JS資産 -->
  <script src="js/leaflet.js"></script>
  <script src="js/L.Control.Layers.Tree.min.js"></script>
  <script src="js/leaflet-hash.js"></script>

  <!-- 既存データ（qgis2web出力） -->
  <script src="data/_2.js"></script>    <!-- 枠 -->
  <script src="data/gis_3.js"></script> <!-- 点（URL等の属性を含む） -->

  <script>
    // ===== 設定：ぼやけ防止・ズーム仕様 =====
    const MAX_NATIVE_ZOOM = 18; // GSIタイルの実用ネイティブ最大
    // ※ “ズームしてもボケない”ためのポイント
    //   1) map.maxZoom を 18（=maxNativeZoom）に制限（過ズーム補間を止める）
    //   2) detectRetina:true（Retinaで高精細タイルを使用）
    //   3) zoomSnap:1 / zoomDelta:1（小数ズームを禁止→CSSスケーリングによるボケ防止）

    // ===== Map =====
    const map = L.map('map', {
      zoomControl: true,
      minZoom: 1,
      maxZoom: MAX_NATIVE_ZOOM,
      zoomSnap: 1,      // ★ 小数ズームを使わない（ボケ防止）
      zoomDelta: 1,     // ★ 1段階ずつ
      wheelDebounceTime: 40,
      zoomAnimation: true
    }).fitBounds([[35.02142399844622,136.88612396178715],[35.02547667835214,136.89563370359895]]);
    new L.Hash(map);

    // 出典
    map.attributionControl.setPrefix('<a href="https://leafletjs.com" target="_blank" rel="noopener">Leaflet</a> · <a href="https://qgis.org" target="_blank" rel="noopener">QGIS</a> · qgis2web');
    map.attributionControl.addAttribution('地理院タイル（国土地理院）');

    // ===== Base layers（ラジオ） =====
    map.createPane('pane_base_photo');  map.getPane('pane_base_photo').style.zIndex = 200;
    map.createPane('pane_base_pale');   map.getPane('pane_base_pale').style.zIndex  = 201;

    // Retina対応＋maxNativeZoom 明示（ボケ防止）
    const layer_photo = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg', {
      pane: 'pane_base_photo',
      detectRetina: true,
      maxNativeZoom: MAX_NATIVE_ZOOM,
      updateWhenZooming: true
    }).addTo(map); // 初期は写真
    const layer_pale = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', {
      pane: 'pane_base_pale',
      detectRetina: true,
      maxNativeZoom: MAX_NATIVE_ZOOM,
      updateWhenZooming: true
    });

    // ===== Frame（枠：常時表示・タッチ透過） =====
    map.createPane('pane_frame'); map.getPane('pane_frame').classList.add('pane-frame');
    map.getPane('pane_frame').style.zIndex = 402;

    const layer_frame = L.geoJSON(json__2, {
      pane:'pane_frame',
      interactive:false,
      style: ()=>({ opacity:1, color:'rgba(227,26,28,1.0)', weight:11, fill:true, fillOpacity:0 })
    }).addTo(map);

    // ===== util =====
    function firstNonEmptyPropValue(props){
      if (!props) return '属性';
      const skip = new Set(['geometry','boundedBy']);
      for (const k of Object.keys(props)){ if (skip.has(k)) continue;
        const v = props[k]; if (v!=null && String(v) !== '') return String(v);
      }
      return '属性';
    }
    function findUrlFromProps(props){
      if (!props) return null;
      for (const k of Object.keys(props)){
        const v = props[k]; if (v==null) continue;
        const s = String(v).trim();
        if (k.toLowerCase()==='url' || k.toLowerCase()==='link' || /^https?:\/\//i.test(s)){
          if (/^https?:\/\//i.test(s)) return s;
        }
      }
      return null;
    }
    function esc(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    // ===== トースト & ポヨッ（肥大化が蓄積しない） =====
    const toastEl = document.getElementById('tapToast');
    function showToast(text){
      toastEl.textContent = text; toastEl.classList.add('show');
      clearTimeout(showToast._t); showToast._t = setTimeout(()=> toastEl.classList.remove('show'), 1000);
    }
    function pulseMarker(layer){
      try{
        if (!layer._baseStyle) {
          layer._baseStyle = { r: layer.options.radius, w: (layer.options.weight || 1) };
        }
        if (layer._pulseTimer) {
          clearTimeout(layer._pulseTimer);
          layer.setStyle({ radius: layer._baseStyle.r, weight: layer._baseStyle.w });
        }
        const R = layer._baseStyle.r, W = layer._baseStyle.w;
        layer.setStyle({ radius: R * 1.35, weight: W + 2 });
        layer._pulseTimer = setTimeout(()=>{
          layer.setStyle({ radius: R, weight: W });
          layer._pulseTimer = null;
        }, 400);
      }catch(e){}
    }

    // ===== Points（gis点：トースト＋ポヨッ＋ポップアップ→リンクでAR開始／“詳細”なし） =====
    map.createPane('pane_points'); map.getPane('pane_points').style.zIndex = 403;
    function style_gis_3_0() {
      return { pane:'pane_points', radius:10, opacity:1, color:'rgba(35,35,35,1.0)', weight:1, fill:true, fillOpacity:1, fillColor:'rgba(229,182,54,1.0)' };
    }
    const layer_points = L.geoJSON(json_gis_3, {
      pane:'pane_points',
      pointToLayer: (f, latlng)=> L.circleMarker(latlng, style_gis_3_0(f)),
      onEachFeature: (feature, layer)=>{
        const props = feature?.properties || {};
        const fid = (props.fid ?? props.id ?? '').toString();
        const url = findUrlFromProps(props);

        const html =
          `<div style="font-size:13px;line-height:1.4;">
            ${fid ? `fid:　${esc(fid)}<br>` : ``}
            ${url ? `URL:　<a href="${esc(url)}" target="_self" rel="noopener">リンク</a>` : ``}
          </div>`;
        layer.bindPopup(html, { maxWidth: 260, closeButton: true, autoClose: true });

        layer.on('click', ()=>{
          const title = firstNonEmptyPropValue(props) || 'ポイント';
          showToast(`選択: ${title}`);
          pulseMarker(layer);
        });
      }
    }).addTo(map);

    // ===== レイヤツリー（前と同じ qgis2web 形式） =====
    const overlaysTree = [
      { label:'<img src="legend/gis_3.png" /> gis点', layer: layer_points },
      { label:'<img src="legend/_2.png" /> 枠', layer: layer_frame },
      { label:'地理院タイル_淡色地図', layer: layer_pale, radioGroup:'bm' },
      { label:'03_地理院タイル_(全国最新写真（シームレス））', layer: layer_photo, radioGroup:'bm' }
    ];
    L.control.layers.tree(null, overlaysTree, {
      collapsed:false,
      position: 'topleft'   // 常に左上（ズーム・ドラッグ・回転でも動かない）
    }).addTo(map);

    // ビューポート変動（回転/バー出し入れ/サイズ変更）でも再計測してボケを避ける
    map.whenReady(()=> map.invalidateSize());
    addEventListener('orientationchange', ()=> setTimeout(()=> map.invalidateSize(), 200), { passive:true });
    addEventListener('resize',            ()=> setTimeout(()=> map.invalidateSize(), 200), { passive:true });
  </script>
</body>
</html>