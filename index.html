<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, width=device-width, viewport-fit=cover, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <!-- 既存のqgis2web資産を利用 -->
  <link rel="stylesheet" href="css/leaflet.css">
  <link rel="stylesheet" href="css/qgis2web.css">

  <style>
    html, body { margin:0; padding:0; height:100%; -webkit-tap-highlight-color: transparent; }
    #map { width:100vw; height:100svh; touch-action: pan-x pan-y pinch-zoom; }

    /* ★ レイヤ欄は“地図の右上”に固定（デフォ動作）。viewport固定CSSは使わない */
    .leaflet-control-layers { max-height: 70svh; overflow:auto; }

    /* 枠は見えるがタップは通す（点のクリックを邪魔しない） */
    .leaflet-pane.pane-frame, .leaflet-pane.pane-frame * { pointer-events: none !important; }

    /* 何をタップしたか一時表示（任意・邪魔なら後で消せます） */
    .toast {
      position: fixed; left: 50%; bottom: 12px; transform: translateX(-50%);
      z-index: 10000; background: rgba(0,0,0,0.78); color:#fff;
      padding: 8px 12px; border-radius: 12px; font-size: 14px; line-height: 1.4;
      opacity: 0; transition: opacity .12s ease; pointer-events:none;
    }
    .toast.show { opacity: 1; }
  </style>

  <title>Webマップ（レイヤ＝地図右上固定／点サイズ不変／高精細）</title>
</head>
<body>
  <div id="map"></div>
  <div id="tapToast" class="toast" aria-live="polite" aria-atomic="true"></div>

  <!-- JS資産 -->
  <script src="js/leaflet.js"></script>
  <script src="js/leaflet-hash.js"></script>

  <!-- データ -->
  <script src="data/_2.js"></script><!-- 枠 -->
  <script src="data/gis_3.js"></script><!-- 点 -->

  <script>
    // ===== ぼやけ防止（GSIタイルのネイティブ上限に合わせる） =====
    const MAX_NATIVE_ZOOM = 18;

    // 小数ズームを使わず、ネイティブ上限以上に拡大しない
    const map = L.map('map', {
      zoomControl: true,
      minZoom: 1,
      maxZoom: MAX_NATIVE_ZOOM,
      zoomSnap: 1,
      zoomDelta: 1,
      wheelDebounceTime: 40,
      zoomAnimation: true
    }).fitBounds([[35.00873592469054,136.8754285322846],[35.03087538697442,136.9122549129309]]);
    new L.Hash(map);

    // 出典
    map.attributionControl.setPrefix('<a href="https://leafletjs.com" target="_blank" rel="noopener">Leaflet</a>');
    map.attributionControl.addAttribution('地理院タイル（国土地理院） / qgis2web / QGIS');

    // ===== ベース地図（Retina対応＋ネイティブ上限を明示） =====
    const gsiPhoto = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg', {
      detectRetina: true,
      maxNativeZoom: MAX_NATIVE_ZOOM,
      updateWhenZooming: true
    });
    const gsiPale  = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', {
      detectRetina: true,
      maxNativeZoom: MAX_NATIVE_ZOOM,
      updateWhenZooming: true
    }).addTo(map); // 初期は淡色

    // ===== Pane設定 =====
    const framePane  = map.createPane('pane_frame');  framePane.classList.add('pane-frame'); framePane.style.zIndex = 330;
    const pointsPane = map.createPane('pane_points'); pointsPane.style.zIndex = 450;

    // ===== 枠（常時表示・タッチ透過） =====
    function style__2_0(){ return { opacity:1, color:'#e31a1c', weight:11, fill:true, fillOpacity:0, interactive:false }; }
    const layer__2 = L.geoJSON(json__2, { pane:'pane_frame', style: style__2_0, interactive:false }).addTo(map);

    // ===== 点（fid と URLリンクのみ／サイズ不変／2ステップ） =====
    const toastEl = document.getElementById('tapToast');
    function showToast(t){
      toastEl.textContent = t;
      toastEl.classList.add('show');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toastEl.classList.remove('show'), 900);
    }
    function firstNonEmpty(props){
      if (!props) return '属性';
      const skip = new Set(['geometry','boundedBy']);
      for (const k of Object.keys(props)){ if (skip.has(k)) continue;
        const v = props[k]; if (v!=null && String(v) !== '') return String(v);
      }
      return '属性';
    }
    function findUrl(props){
      if (!props) return null;
      for (const k of Object.keys(props)){
        const v = props[k]; if (v==null) continue;
        const s = String(v).trim();
        if (k.toLowerCase()==='url' || k.toLowerCase()==='link' || /^https?:\/\//i.test(s)){
          if (/^https?:\/\//i.test(s)) return s;
        }
      }
      return null;
    }
    function esc(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    function style_gis_3_0(){ return { radius:8, color:'#000', weight:2, fill:true, fillColor:'#fff', fillOpacity:1 }; }

    const layer_gis_3 = L.geoJSON(json_gis_3, {
      pane:'pane_points',
      pointToLayer: (f, latlng)=> L.circleMarker(latlng, style_gis_3_0(f)),
      onEachFeature: (feature, layer)=>{
        const p   = feature?.properties || {};
        const href = findUrl(p);
        const fid  = (p.fid != null ? String(p.fid) : (p.id != null ? String(p.id) : ''));

        // ポップアップは「fid / URL: リンク」のみ（サイズ変更なし／自動遷移なし）
        const html =
          `<div style="font-size:13px;line-height:1.4;">
            ${fid ? `fid：${esc(fid)}<br>` : ``}
            ${href ? `URL：<a href="${esc(href)}" target="_self" rel="noopener">リンク</a>` : `URL：—`}
          </div>`;
        layer.bindPopup(html, { maxWidth: 260, closeButton: true, autoClose: true });

        // クリック時：トーストのみ（点の大きさは一切変更しない）
        layer.on('click', ()=>{
          const title = firstNonEmpty(p) || 'ポイント';
          showToast(`選択: ${title}`);
        });
      }
    }).addTo(map);

    // ===== レイヤコントロール：地図の右上に固定（デフォルト挙動） =====
    L.control.layers(
      { "地理院タイル_淡色地図": gsiPale, "全国最新写真（シームレス）": gsiPhoto },
      { "gis点": layer_gis_3, "枠": layer__2 },
      { collapsed:false, position:'topright' }   // ★ 地図の右上に固定
    ).addTo(map);

    // ビューポート変動時のレイアウト再計測（ボケやズレ防止）
    map.whenReady(()=> map.invalidateSize());
    addEventListener('orientationchange', ()=> setTimeout(()=> map.invalidateSize(), 200), { passive:true });
    addEventListener('resize',            ()=> setTimeout(()=> map.invalidateSize(), 200), { passive:true });
  </script>
</body>
</html>