<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, width=device-width, viewport-fit=cover, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <!-- 既存のqgis2web資産を利用 -->
  <link rel="stylesheet" href="css/leaflet.css">
  <link rel="stylesheet" href="css/qgis2web.css">

  <style>
    html, body { margin:0; padding:0; height:100%; -webkit-tap-highlight-color: transparent; }
    #map { width:100vw; height:100svh; touch-action: pan-x pan-y pinch-zoom; }

    /* ★ レイヤ欄は“地図の右上”に追従（Leaflet標準の absolute を強制。固定化はしない） */
    .leaflet-top, .leaflet-bottom { position: absolute !important; }
    .leaflet-control-layers { max-height: 70svh; overflow:auto; }

    /* 枠は見えるがタップは通す（点のクリックを邪魔しない） */
    .leaflet-pane.pane-frame, .leaflet-pane.pane-frame * { pointer-events: none !important; }

    /* 何をタップしたか一時表示（任意・邪魔なら削除可。点サイズは変えません） */
    .toast {
      position: fixed; left: 50%; bottom: 12px; transform: translateX(-50%);
      z-index: 10000; background: rgba(0,0,0,0.78); color:#fff;
      padding: 8px 12px; border-radius: 12px; font-size: 14px; line-height: 1.4;
      opacity: 0; transition: opacity .12s ease; pointer-events:none;
    }
    .toast.show { opacity: 1; }
  </style>

  <title>Webマップ（地図右上追従＋アンチ巨大化）</title>
</head>
<body>
  <div id="map"></div>
  <div id="tapToast" class="toast" aria-live="polite" aria-atomic="true"></div>

  <!-- JS資産 -->
  <script src="js/leaflet.js"></script>
  <script src="js/leaflet-hash.js"></script>

  <!-- データ -->
  <script src="data/_2.js"></script><!-- 枠 -->
  <script src="data/gis_3.js"></script><!-- 点 -->

  <script>
    // ===== ぼやけ防止 =====
    const MAX_NATIVE_ZOOM = 18;

    const map = L.map('map', {
      zoomControl: true,
      minZoom: 1,
      maxZoom: MAX_NATIVE_ZOOM,
      zoomSnap: 1,         // 小数ズーム抑制（ボケ防止）
      zoomDelta: 1,
      wheelDebounceTime: 40,
      zoomAnimation: true
    }).fitBounds([[35.00873592469054,136.8754285322846],[35.03087538697442,136.9122549129309]]);

    // レイヤ欄＝地図の“右上”に追従（標準）
    map.zoomControl.setPosition('topright');
    new L.Hash(map);

    // 出典
    map.attributionControl.setPrefix('<a href="https://leafletjs.com" target="_blank" rel="noopener">Leaflet</a>');
    map.attributionControl.addAttribution('地理院タイル（国土地理院） / qgis2web / QGIS');

    // ===== ベース地図（Retina対応＋ネイティブ上限を明示） =====
    const basePhoto = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg', {
      detectRetina: true,
      maxNativeZoom: MAX_NATIVE_ZOOM,
      updateWhenZooming: true
    });
    const basePale  = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', {
      detectRetina: true,
      maxNativeZoom: MAX_NATIVE_ZOOM,
      updateWhenZooming: true
    }).addTo(map); // 初期は淡色

    // ===== Pane =====
    const framePane  = map.createPane('pane_frame');  framePane.classList.add('pane-frame'); framePane.style.zIndex = 330;
    const pointsPane = map.createPane('pane_points'); pointsPane.style.zIndex = 450;

    // ===== “ズームしても巨大に見えない”可変スタイル関数 =====
    // 高ズームほど細く/小さくする。視覚的なバランスを保つための経験則です。
    function sizeForZoom(z){
      // 点半径：z12→7px / z15→5px / z18→3-4px
      const r = Math.max(3, Math.round(-0.8 * z + 16));
      // 枠の太さ：z12→6px / z15→3px / z18→1px
      const w = Math.max(1, Math.round(-1.2 * z + 20));
      return { r, w };
    }

    // ===== 枠（常時表示・タッチ透過） =====
    let currentFrameWeight = sizeForZoom(map.getZoom()).w;
    function style_frame(){ return { opacity:1, color:'#e31a1c', weight: currentFrameWeight, fill:true, fillOpacity:0, interactive:false }; }
    const layer_frame = L.geoJSON(json__2, { pane:'pane_frame', style: style_frame, interactive:false }).addTo(map);

    // ===== 点（fid と URLリンクのみ／自動遷移なし／タップしてもサイズ不変） =====
    const toastEl = document.getElementById('tapToast');
    function showToast(t){
      toastEl.textContent = t;
      toastEl.classList.add('show');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toastEl.classList.remove('show'), 800);
    }
    function firstNonEmpty(props){
      if (!props) return 'ポイント';
      const skip = new Set(['geometry','boundedBy']);
      for (const k of Object.keys(props)){ if (skip.has(k)) continue;
        const v = props[k]; if (v!=null && String(v) !== '') return String(v);
      }
      return 'ポイント';
    }
    function findUrl(props){
      if (!props) return null;
      for (const k of Object.keys(props)){
        const v = props[k]; if (v==null) continue;
        const s = String(v).trim();
        if (k.toLowerCase()==='url' || k.toLowerCase()==='link' || /^https?:\/\//i.test(s)){
          if (/^https?:\/\//i.test(s)) return s;
        }
      }
      return null;
    }
    function esc(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    let currentPointRadius = sizeForZoom(map.getZoom()).r;
    function style_point(){ return { radius: currentPointRadius, color:'#000', weight:1, fill:true, fillColor:'#fff', fillOpacity:1 }; }

    const layer_points = L.geoJSON(json_gis_3, {
      pane:'pane_points',
      pointToLayer: (f, latlng)=> L.circleMarker(latlng, style_point()),
      onEachFeature: (feature, layer)=>{
        const p   = feature?.properties || {};
        const url = findUrl(p);
        const fid = (p.fid != null ? String(p.fid) : (p.id != null ? String(p.id) : ''));

        const html =
          `<div style="font-size:13px;line-height:1.4;">
            ${fid ? `fid：${esc(fid)}<br>` : ``}
            ${url ? `URL：<a href="${esc(url)}" target="_self" rel="noopener">リンク</a>` : `URL：—`}
          </div>`;
        layer.bindPopup(html, { maxWidth: 260, closeButton: true, autoClose: true });

        layer.on('click', ()=> showToast(`選択: ${firstNonEmpty(p)}`));
      }
    }).addTo(map);

    // ===== ズームに応じて見た目を調整（アンチ巨大化） =====
    function applyZoomAdaptiveStyles(){
      const z = map.getZoom();
      const sz = sizeForZoom(z);
      // 点
      currentPointRadius = sz.r;
      layer_points.eachLayer(l => l.setStyle({ radius: currentPointRadius, weight: 1 }));
      // 枠
      currentFrameWeight = sz.w;
      layer_frame.setStyle({ weight: currentFrameWeight });
    }
    map.on('zoomend', applyZoomAdaptiveStyles);
    applyZoomAdaptiveStyles(); // 初期適用

    // ===== レイヤコントロール（地図の右上に追従） =====
    L.control.layers(
      { "地理院タイル_淡色地図": basePale, "全国最新写真（シームレス）": basePhoto },
      { "gis点": layer_points, "枠": layer_frame },
      { collapsed:false, position:'topright' }
    ).addTo(map);

    // レイアウト確定（回転・アドレスバー変動など）
    map.whenReady(()=> map.invalidateSize());
    addEventListener('orientationchange', ()=> setTimeout(()=> map.invalidateSize(), 200), { passive:true });
    addEventListener('resize',            ()=> setTimeout(()=> map.invalidateSize(), 200), { passive:true });
  </script>
</body>
</html>