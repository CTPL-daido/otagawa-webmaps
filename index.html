<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, width=device-width, viewport-fit=cover, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <!-- 既存資産 -->
  <link rel="stylesheet" href="css/leaflet.css">
  <link rel="stylesheet" href="css/qgis2web.css">

  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; -webkit-tap-highlight-color: transparent; }
    #map { width:100vw; height:100svh; touch-action: pan-x pan-y pinch-zoom; }

    /* ===== レイヤ欄：画面左上に“常に固定” ===== */
    .leaflet-top.leaflet-left{
      position: fixed;   /* ビューポート基準で固定 */
      top: 8px;
      left: 8px;
      z-index: 10050;    /* 地図より常に上 */
      width: auto;
      pointer-events: auto;
    }
    .leaflet-control-layers { max-height: 70svh; overflow:auto; }
    /* ズームボタン類と干渉しにくい余白（必要なら値を調整） */
    .leaflet-top.leaflet-left .leaflet-control-layers { margin-top: 46px; }

    /* 枠レイヤは常時表示しつつタッチ透過（点のタップを邪魔しない） */
    .leaflet-pane.pane-frame,
    .leaflet-pane.pane-frame * { pointer-events: none !important; }

    /* 何をタップしたか一時表示（任意の軽いフィードバック） */
    .toast {
      position: fixed; left: 50%; bottom: 12px; transform: translateX(-50%);
      z-index: 10000; background: rgba(0,0,0,0.78); color:#fff;
      padding: 8px 12px; border-radius: 12px; font-size: 14px; line-height: 1.4;
      opacity: 0; transition: opacity .12s ease; pointer-events:none;
    }
    .toast.show { opacity: 1; }
  </style>

  <title>Web Map（左上固定＋高精細ズーム）</title>
</head>
<body>
  <div id="map"></div>
  <div id="tapToast" class="toast" aria-live="polite" aria-atomic="true"></div>

  <!-- JS資産 -->
  <script src="js/leaflet.js"></script>
  <script src="js/leaflet-hash.js"></script>
  <script src="js/Autolinker.min.js"></script>

  <!-- データ -->
  <script src="data/_2.js"></script>    <!-- 枠 -->
  <script src="data/gis_3.js"></script> <!-- 点 -->

  <script>
    // ===== ぼやけ防止設定 =====
    const MAX_NATIVE_ZOOM = 18; // 地理院タイルの実用上限
    // 小数ズームを使わず、ネイティブ上限以上に拡大しない
    const map = L.map('map', {
      zoomControl: true,
      minZoom: 1,
      maxZoom: MAX_NATIVE_ZOOM,
      zoomSnap: 1,
      zoomDelta: 1,
      wheelDebounceTime: 40,
      zoomAnimation: true
    }).fitBounds([[35.00873592469054,136.8754285322846],[35.03087538697442,136.9122549129309]]);

    // ズームボタンは右上へ寄せて、左上のレイヤ欄と重ならないように
    map.zoomControl.setPosition('topright');

    new L.Hash(map);

    // 出典
    map.attributionControl.setPrefix('<a href="https://leafletjs.com" target="_blank" rel="noopener">Leaflet</a>');
    map.attributionControl.addAttribution('地理院タイル（国土地理院） / qgis2web / QGIS');

    // ===== ベース地図（Retina対応＋ネイティブ上限を明示） =====
    const gsiPhoto = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg', {
      detectRetina: true,
      maxNativeZoom: MAX_NATIVE_ZOOM,
      updateWhenZooming: true
    });
    const gsiPale  = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', {
      detectRetina: true,
      maxNativeZoom: MAX_NATIVE_ZOOM,
      updateWhenZooming: true
    }).addTo(map); // 初期は淡色

    // ===== Pane設定 =====
    const framePane  = map.createPane('pane_frame');  framePane.classList.add('pane-frame'); framePane.style.zIndex = 330;
    const pointsPane = map.createPane('pane_points'); pointsPane.style.zIndex = 450;

    // ===== 枠（常時表示・タッチ透過） =====
    function style__2_0(){ return { opacity:1, color:'#e31a1c', weight:11, fill:true, fillOpacity:0, interactive:false }; }
    const layer__2 = L.geoJSON(json__2, { pane:'pane_frame', style: style__2_0, interactive:false }).addTo(map);

    // ===== 点（fid と URLリンクだけを表示／自動遷移なし） =====
    const autolinker = new Autolinker({ truncate:{ length:30, location:'smart' } });

    // 軽いフィードバック（トースト＋ポヨッ）。サイズが蓄積しないよう制御
    const toastEl = document.getElementById('tapToast');
    function showToast(t){ toastEl.textContent=t; toastEl.classList.add('show'); clearTimeout(showToast._t); showToast._t = setTimeout(()=> toastEl.classList.remove('show'), 900); }
    function pulse(layer){
      try{
        if (!layer._baseStyle){ layer._baseStyle = { r: layer.options.radius, w: (layer.options.weight||1) }; }
        if (layer._pulseTimer){ clearTimeout(layer._pulseTimer); layer.setStyle({ radius: layer._baseStyle.r, weight: layer._baseStyle.w }); }
        const {r,w} = layer._baseStyle;
        layer.setStyle({ radius: r*1.35, weight: w+2 });
        layer._pulseTimer = setTimeout(()=>{ layer.setStyle({ radius:r, weight:w }); layer._pulseTimer=null; }, 380);
      }catch(e){}
    }

    function style_gis_3_0(){ return { radius:8, color:'#000', weight:2, fill:true, fillColor:'#fff', fillOpacity:1 }; }
    function onEach_gis_3(feature, layer){
      const p   = feature.properties || {};
      const href = (p.URL || p.url || p.Url || p.link || '').toString().trim();
      const fid  = (p.fid != null ? String(p.fid) : (p.id != null ? String(p.id) : ''));

      const html =
        '<div style="font-size:13px;line-height:1.4;">' +
          (fid  ? 'fid：'+ autolinker.link(fid) + '<br>' : '') +
          (href ? 'URL：<a href="'+href+'" target="_self" rel="noopener">リンク</a>' : 'URL：—') +
        '</div>';
      layer.bindPopup(html, { maxWidth: 260, closeButton: true, autoClose: true });

      layer.on('click', ()=>{
        showToast('選択: ' + (p.NAME || p.name || p.名称 || fid || 'ポイント'));
        pulse(layer);
      });
    }
    const layer_gis_3 = L.geoJSON(json_gis_3, {
      pane:'pane_points',
      pointToLayer: (f, latlng)=> L.circleMarker(latlng, style_gis_3_0(f)),
      onEachFeature: onEach_gis_3
    }).addTo(map);

    // ===== レイヤコントロール（左上固定に加えてAPI上も左上指定） =====
    L.control.layers(
      { "地理院タイル_淡色地図": gsiPale, "全国最新写真（シームレス）": gsiPhoto },
      { "gis点": layer_gis_3, "枠": layer__2 },
      { collapsed:false, position:'topleft' }
    ).addTo(map);

    // ビューポート変動時のレイアウト再計測（ボケやズレ防止）
    map.whenReady(()=> map.invalidateSize());
    addEventListener('orientationchange', ()=> setTimeout(()=> map.invalidateSize(), 200), { passive:true });
    addEventListener('resize',            ()=> setTimeout(()=> map.invalidateSize(), 200), { passive:true });
  </script>
</body>
</html>