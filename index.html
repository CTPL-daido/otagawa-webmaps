<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>WEBマップ（自前レイヤーパネル版）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <!-- Leaflet（CDN） -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { width: 100%; height: 100%; /* スマホのピンチズームOK */ touch-action: pan-x pan-y pinch-zoom; }

    /* 自前レイヤーパネル */
    .layer-panel {
      position: absolute; top: 10px; left: 10px; z-index: 1000;
      background: rgba(255,255,255,.92); backdrop-filter: blur(4px);
      border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,.15);
      padding: 10px 12px; font: 14px/1.4 system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", "Yu Gothic", "Meiryo", sans-serif;
    }
    .layer-panel h3 { margin: 0 0 6px; font-size: 14px; }
    .layer-panel .sec { margin-top: 8px; }
    .layer-panel label { display: flex; align-items: center; gap: 6px; margin: 4px 0; }

    /* 出典ボックス（地理院タイルの帰属を明示） */
    .credit {
      position: absolute; right: 8px; bottom: 8px; z-index: 1000;
      background: rgba(255,255,255,.9); padding: 6px 8px; border-radius: 10px;
      font: 12px/1.3 system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", "Yu Gothic", "Meiryo", sans-serif;
      box-shadow: 0 4px 12px rgba(0,0,0,.12);
    }

    /* 枠レイヤーは常時ON、タップを透過（点をタップできるように） */
    .leaflet-pane.frame-pane { z-index: 550; pointer-events: none; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- 自前レイヤーパネル -->
  <div class="layer-panel" id="layerPanel">
    <h3>レイヤ</h3>
    <div class="sec">
      <strong>ベース</strong>
      <div><label><input type="radio" name="base" value="gsi_pale" checked> 地理院タイル（淡色）</label></div>
      <div><label><input type="radio" name="base" value="gsi_std"> 地理院タイル（標準）</label></div>
      <div><label><input type="radio" name="base" value="osm"> OpenStreetMap</label></div>
    </div>
    <div class="sec">
      <strong>オーバーレイ</strong>
      <div><label><input type="checkbox" data-overlay="points" checked> 地点（タップ可）</label></div>
      <div><label><input type="checkbox" data-overlay="lines" checked> 線・範囲</label></div>
      <div><label><input type="checkbox" data-overlay="labels"> ラベル</label></div>
      <div><label>
        <input type="checkbox" checked disabled>
        枠（常時ON・点はタップ可）
      </label></div>
    </div>
  </div>

  <!-- 出典（明示） -->
  <div class="credit">
    出典：<a href="https://maps.gsi.go.jp/development/ichiran.html" target="_blank" rel="noopener">国土地理院タイル</a>、© OpenStreetMap contributors
  </div>

  <script>
    // --- 地図本体 ---
    const map = L.map('map', {
      zoomControl: true,
      attributionControl: true,
      // スマホ操作の安定化（Leaflet既定でピンチズーム可）
      tap: false,
      minZoom: 4, maxZoom: 19
    }).setView([35.0, 136.9], 13); // ← 初期中心・ズーム（必要に応じて更新）

    map.attributionControl.setPrefix(''); // "Leaflet" 表示を消す（表記は出典ボックスで明示）

    // --- ベースレイヤ（地理院・OSM） ---
    const gsi_pale = L.tileLayer(
      'https://tile-c.openstreetmap.jp/styles/gsi-pale/{z}/{x}/{y}.png',
      { maxZoom: 19, attribution: '国土地理院タイル（淡色地図）' }
    );

    const gsi_std = L.tileLayer(
      'https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png',
      { maxZoom: 19, attribution: '国土地理院タイル（標準地図）' }
    );

    const osm = L.tileLayer(
      'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      { maxZoom: 19, attribution: '© OpenStreetMap contributors' }
    );

    const baseLayers = { gsi_pale, gsi_std, osm };
    gsi_pale.addTo(map);

    // --- パン（pane）設定：枠は専用paneで最前面＆非インタラクティブ ---
    const framePane = map.createPane('frame-pane');
    framePane.classList.add('frame-pane'); // CSSでpointer-events: none

    // --- オーバーレイ入れ物 ---
    const overlay = {
      points: L.layerGroup().addTo(map),
      lines: L.layerGroup().addTo(map),
      labels: L.layerGroup(),     // 初期OFF
      frame: L.layerGroup({ pane: 'frame-pane' }).addTo(map) // 常時ON
    };

    // --- qgis2webのGeoJSONを読み込み（ファイル名を差し替えてください） ---
    // 例：
    //  1) 点: points.geojson（properties: name, url があるとリンク生成）
    //  2) 線/面: lines.geojson
    //  3) ラベル: labels.geojson（必要なら）
    //  4) 枠: frame.geojson（境界線など。常時ON）
    Promise.all([
      fetch('points.geojson').then(r => r.ok ? r.json() : null),
      fetch('lines.geojson').then(r => r.ok ? r.json() : null),
      fetch('labels.geojson').then(r => r.ok ? r.json() : null),
      fetch('frame.geojson').then(r => r.ok ? r.json() : null)
    ]).then(([points, lines, labels, frame]) => {
      if (points) {
        L.geoJSON(points, {
          pointToLayer: (f, latlng) => L.circleMarker(latlng, {
            radius: 8, weight: 2, color: '#333', fillColor: '#4db', fillOpacity: 0.9
          }),
          onEachFeature: (f, layer) => {
            const p = f.properties || {};
            const name = p.name || '地点';
            const url = p.url;
            let html = `<strong>${name}</strong>`;
            if (url) html += `<br><a href="${url}" target="_blank" rel="noopener">開く</a>`;
            layer.bindPopup(html, { maxWidth: 260 });
          }
        }).addTo(overlay.points);
      }

      if (lines) {
        L.geoJSON(lines, {
          style: f => ({ color: '#1e88e5', weight: 3, opacity: 0.9, fillOpacity: 0.05 })
        }).addTo(overlay.lines);
      }

      if (labels) {
        L.geoJSON(labels, {
          pointToLayer: (f, latlng) => L.marker(latlng, { interactive: false }),
          onEachFeature: (f, layer) => {
            const name = (f.properties && f.properties.name) || '';
            if (name) layer.bindTooltip(name, { permanent: true, direction: 'center', className: 'lbl' });
          }
        }).addTo(overlay.labels);
      }

      if (frame) {
        L.geoJSON(frame, {
          pane: 'frame-pane',
          interactive: false, // タップ透過（点をタップ可能に）
          style: f => ({ color: '#000', weight: 2, opacity: 1, fill: false })
        }).addTo(overlay.frame);
      }

      // GeoJSONがあれば自動ズーム
      const all = L.featureGroup([overlay.points, overlay.lines, overlay.labels, overlay.frame]);
      try {
        map.fitBounds(all.getBounds(), { padding: [20, 20] });
      } catch (_) {}
    });

    // --- 自前レイヤーパネルの挙動 ---
    document.getElementById('layerPanel').addEventListener('change', (e) => {
      const t = e.target;
      // ベース切替
      if (t.name === 'base') {
        Object.entries(baseLayers).forEach(([key, tl]) => {
          if (key === t.value) {
            if (!map.hasLayer(tl)) tl.addTo(map);
          } else {
            if (map.hasLayer(tl)) map.removeLayer(tl);
          }
        });
      }
      // オーバーレイON/OFF
      if (t.dataset.overlay) {
        const key = t.dataset.overlay;
        if (t.checked) {
          overlay[key].addTo(map);
        } else {
          map.removeLayer(overlay[key]);
        }
      }
    });

    // --- 使い方メモ（必要なら）：長押しでドラッグ、ピンチでズーム、点をタップでポップアップ ---
  </script>
</body>
</html>