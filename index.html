<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>地理院タイル切替マップ（スマホ安定版＋出典表示）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- Leaflet（CDN） -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster（CDN） -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- Hash（CDN） -->
  <script src="https://unpkg.com/leaflet-hash@0.2.1/leaflet-hash.js"></script>

  <style>
    /* 全画面＆モバイル操作の安定化 */
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    body { overscroll-behavior: none; touch-action: pan-x pan-y; }
    #map { padding-bottom: env(safe-area-inset-bottom); }

    /* レイヤーコントロールをスマホで確実に触れるよう調整 */
    .leaflet-top.leaflet-right { top: 10px; right: 10px; z-index: 1000; }
    .leaflet-control-layers {
      max-height: 60vh;
      overflow-y: auto;
      background: rgba(255,255,255,.97);
      font-size: 16px;              /* タップしやすい */
      -webkit-overflow-scrolling: touch;
    }
    .leaflet-control-zoom a {
      width: 40px; height: 40px; line-height: 40px; font-size: 20px;
    }

    /* 出典の視認性を少し上げる（必要なら調整） */
    .leaflet-control-attribution {
      background: rgba(255,255,255,.9);
      padding: 2px 6px;
      border-radius: 4px 0 0 0;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- ▼ qgis2web のデータ（名前は何でもOK。存在するファイルを読み込ませてください） -->
  <script src="data/_1.js"></script>
  <script src="data/gis_2.js"></script>
  <!-- ▲ 追加のレイヤがあるなら <script src="data/xxx.js"></script> を足してください -->

  <script>
    // ===== マップ初期化 =====
    const map = L.map('map', { zoomControl:false, maxZoom:18, minZoom:1, tap:true })
                 .fitBounds([[35.018,136.883],[35.028,136.900]]);

    new L.Hash(map);

    // 左下：固定クレジット（ここは常時表示）
    map.attributionControl.setPrefix(
      '<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> · ' +
      '<a href="https://leafletjs.com" target="_blank">Leaflet</a> · ' +
      '<a href="https://qgis.org" target="_blank">QGIS</a>'
    );

    // 左上ズーム
    L.control.zoom({ position: 'topleft' }).addTo(map);

    // ===== ベースマップ（標準Layers：最も安定） =====
    const gsiListUrl = 'https://maps.gsi.go.jp/development/ichiran.html';

    const basePale = L.tileLayer(
      'https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png',
      {
        minZoom: 1, maxZoom: 18,
        attribution: '出典：<a href="'+gsiListUrl+'" target="_blank" rel="noopener">地理院タイル</a>（淡色地図）'
      }
    ).addTo(map); // 初期は淡色

    const basePhoto = L.tileLayer(
      'https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg',
      {
        minZoom: 1, maxZoom: 18,
        attribution: '出典：<a href="'+gsiListUrl+'" target="_blank" rel="noopener">地理院タイル</a>（全国最新写真）'
      }
    );

    const baseMaps = {
      '地理院タイル（淡色地図）': basePale,
      '地理院タイル（全国最新写真）': basePhoto
    };

    // ===== data/*.js の中身を自動検出（名前違いでも動く） =====
    function collectGeoJSON() {
      const polys = [], points = [];
      for (const k in window) {
        if (!/^json[_A-Za-z0-9]*$/.test(k)) continue;
        const v = window[k];
        if (!v || v.type !== 'FeatureCollection' || !Array.isArray(v.features) || v.features.length === 0) continue;
        const g = v.features[0]?.geometry?.type;
        if (g === 'Polygon' || g === 'MultiPolygon') polys.push(v);
        if (g === 'Point'   || g === 'MultiPoint')   points.push(v);
      }
      return { polys, points };
    }
    const found = collectGeoJSON();

    // ===== オーバーレイ作成 =====
    const overlays = {};
    let layerPolygon = null, layerPointsRaw = null;

    if (found.polys.length) {
      const polyFC = found.polys.length > 1
        ? { type:'FeatureCollection', features: found.polys.flatMap(v => v.features) }
        : found.polys[0];

      layerPolygon = L.geoJSON(polyFC, {
        interactive: true,
        style: () => ({ color: 'red', weight: 3, opacity: 1, fill: false }),
        onEachFeature: (f, layer) => {
          layer.bindPopup('<table><tr><td>fid:</td><td>' + (f.properties?.fid ?? '') + '</td></tr></table>');
        }
      }).addTo(map);

      overlays['枠（ポリゴン）'] = layerPolygon;
    }

    if (found.points.length) {
      const pointFC = found.points.length > 1
        ? { type:'FeatureCollection', features: found.points.flatMap(v => v.features) }
        : found.points[0];

      layerPointsRaw = L.geoJSON(pointFC, {
        interactive: true,
        pointToLayer: (f, latlng) => L.circleMarker(latlng, {
          radius: 6, fillColor: '#ffcc00', color: '#000', weight: 1, opacity: 1, fillOpacity: 1
        }),
        onEachFeature: (f, layer) => {
          const link = f.properties?.url || f.properties?.URL;
          let html = '<table><tr><td>fid:</td><td>' + (f.properties?.fid ?? '') + '</td></tr>';
          if (link) html += '<tr><td>URL:</td><td><a href="'+link+'" target="_blank" rel="noopener">リンク</a></td></tr>';
          html += '</table>';
          layer.bindPopup(html);
        }
      });

      const clusterPoints = L.markerClusterGroup({
        showCoverageOnHover: false,
        spiderfyOnMaxZoom: true,
        disableClusteringAtZoom: 17
      }).addLayer(layerPointsRaw).addTo(map);

      overlays['gis点（クラスタ）'] = clusterPoints;
    }

    // ===== レイヤーコントロール（右上に固定・展開状態） =====
    L.control.layers(baseMaps, overlays, {
      collapsed: false,
      position: 'topright'
    }).addTo(map);

    // ===== 表示範囲（データに合わせる） =====
    const toBound = [];
    if (layerPolygon)   toBound.push(layerPolygon);
    if (layerPointsRaw) toBound.push(layerPointsRaw);
    if (toBound.length) {
      const fg = L.featureGroup(toBound);
      map.fitBounds(fg.getBounds(), { padding: [10, 10] });
    }
  </script>
</body>
</html>