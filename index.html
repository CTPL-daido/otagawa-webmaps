<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, width=device-width, viewport-fit=cover, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="stylesheet" href="css/leaflet.css">
  <link rel="stylesheet" href="css/qgis2web.css">
  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; -webkit-tap-highlight-color: transparent; }
    /* iOSバーの高さ変動に強い全画面 */
    #map { width:100vw; height:100svh; }
    .leaflet-interactive { cursor:pointer; }
    /* 出典が確実に表示されるよう強制 */
    .leaflet-control-attribution { display:block !important; font-size:12px; }
    /* レイヤーコントロールをモバイルで押しやすく */
    .leaflet-control-layers { max-height: 70svh; overflow:auto; }
  </style>
  <title>Web Map</title>
</head>
<body>
  <div id="map"></div>

  <script src="js/leaflet.js"></script>
  <script src="js/leaflet-hash.js"></script>
  <script src="js/Autolinker.min.js"></script>
  <script src="data/_2.js"></script>
  <script src="data/gis_3.js"></script>

  <script>
    // ===== Map（スマホ操作すべて有効）=====
    const map = L.map('map', {
      zoomControl: true,
      dragging: true,
      touchZoom: true,
      tap: true,
      scrollWheelZoom: true,
      maxZoom: 20, minZoom: 1
    }).fitBounds([[35.00873592469054,136.8754285322846],[35.03087538697442,136.9122549129309]]);
    new L.Hash(map);

    // 出典（右下）
    map.attributionControl.setPrefix(
      '<a href="https://leafletjs.com" target="_blank">Leaflet</a>'
    );
    map.attributionControl.addAttribution('地理院タイル（国土地理院） / qgis2web / QGIS');

    // ===== ベースレイヤ（2種類） =====
    const gsiPhoto = L.tileLayer(
      'https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg',
      { minZoom:1, maxZoom:20, minNativeZoom:2, maxNativeZoom:18 }
    );
    const gsiPale = L.tileLayer(
      'https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png',
      { minZoom:1, maxZoom:20, minNativeZoom:2, maxNativeZoom:18 }
    ).addTo(map); // 初期表示

    // ===== オーバーレイ：枠（_2） =====
    function style__2_0() {
      return { opacity:1, color:'#e31a1c', weight:11, fill:true, fillOpacity:0, interactive:true };
    }
    const layer__2 = L.geoJSON(json__2, { style: style__2_0 });

    // ===== オーバーレイ：点（gis_3）ポップアップに「リンク：URL」 =====
    const autolinker = new Autolinker({ truncate:{ length:30, location:'smart' } });
    function style_gis_3_0() {
      return { radius:8, color:'#000', weight:2, fill:true, fillColor:'#fff', fillOpacity:1 };
    }
    function onEach_gis_3(feature, layer){
      const href = (feature.properties && (feature.properties.URL || feature.properties.url)) ?
        String(feature.properties.URL || feature.properties.url) : '';
      const fid  = feature.properties && feature.properties.fid != null ? String(feature.properties.fid) : '';
      const html =
        '<table>' +
          '<tr><td colspan="2">'+ autolinker.link(fid) +'</td></tr>' +
          '<tr><td colspan="2">'+ (href ? 'リンク：<br><a href="'+href+'" target="_self">'+href+'</a>' : 'リンク：—') +'</td></tr>' +
        '</table>';
      layer.bindPopup(html, { maxHeight: 400 });
    }
    const layer_gis_3 = L.geoJSON(json_gis_3, {
      pointToLayer: (f, latlng)=> L.circleMarker(latlng, style_gis_3_0(f)),
      onEachFeature: onEach_gis_3
    }).addTo(map);

    // ===== レイヤーコントロール（常時表示・右上） =====
    L.control.layers(
      { "地理院タイル_淡色地図": gsiPale, "全国最新写真（シームレス）": gsiPhoto },
      { "gis点": layer_gis_3, "枠": layer__2 },
      { collapsed:false, position:'topright' }
    ).addTo(map);

    // 画面回転/アドレスバー変動でサイズ再計算
    addEventListener('resize', ()=> map.invalidateSize(), { passive:true });
  </script>
</body>
</html>